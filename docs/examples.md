# Examples

Practical examples and real-world use cases for templr.

## Table of Contents

- [Single File Rendering](#single-file-rendering)
- [Directory Mode](#directory-mode)
- [Walk Mode](#walk-mode)
- [Linting and Validation](#linting-and-validation)
- [CI/CD Integration](#cicd-integration)
- [Team Workflows](#team-workflows)
- [Advanced Patterns](#advanced-patterns)

## Single File Rendering

### Basic Rendering

**template.tpl:**
```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .name }}
  namespace: {{ .namespace }}
data:
  environment: {{ .environment }}
  version: {{ .version }}
```

**values.yaml:**
```yaml
name: myapp-config
namespace: production
environment: prod
version: "1.0.0"
```

**Render:**
```bash
templr render -in template.tpl -data values.yaml -out config.yaml
```

### Using --set Overrides

```bash
# Override specific values
templr render -in template.tpl -data values.yaml --set environment=staging

# Multiple overrides
templr render -in template.tpl -data values.yaml \
  --set environment=dev \
  --set version=1.1.0

# Nested values
templr render -in template.tpl --set app.name=myapp --set app.version=1.0.0
```

### Stdin/Stdout Usage

```bash
# Read template from stdin
echo 'Hello {{ .name }}!' | templr render --set name=World

# Write to stdout
templr render -in template.tpl -data values.yaml > output.txt

# Pipeline
cat template.tpl | templr render -data values.yaml | grep version
```

### Multiple Data Files

```bash
# Layer data files (later files override earlier)
templr render -in template.tpl \
  -data base.yaml \
  -f environment.yaml \
  -f secrets.yaml \
  --set instance=server-01
```

**Precedence:** `--set > -f (last) > ... > -f (first) > -data`

---

## Directory Mode

### Shared Helpers

**Directory structure:**
```
templates/
├── _helpers.tpl
├── main.tpl
└── service.tpl
```

**_helpers.tpl:**
```gotmpl
{{- define "app.name" -}}
{{ .Release.Name }}-{{ .Chart.Name }}
{{- end -}}

{{- define "app.labels" -}}
app: {{ include "app.name" . }}
version: {{ .Chart.Version }}
environment: {{ .Values.environment }}
{{- end -}}
```

**main.tpl:**
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "app.name" . }}
  labels:
    {{- include "app.labels" . | nindent 4 }}
spec:
  replicas: {{ .Values.replicas }}
  template:
    metadata:
      labels:
        {{- include "app.labels" . | nindent 8 }}
```

**Render:**
```bash
templr dir --dir templates/ -in main.tpl -data values.yaml -out deployment.yaml
```

---

## Walk Mode

### Basic Walk

```bash
# Render entire directory tree
templr walk --src templates/ --dst output/
```

**Input:**
```
templates/
├── app/
│   ├── deployment.yaml.tpl
│   └── service.yaml.tpl
├── database/
│   └── statefulset.yaml.tpl
└── values.yaml
```

**Output:**
```
output/
├── app/
│   ├── deployment.yaml
│   └── service.yaml
└── database/
    └── statefulset.yaml
```

### Multiple File Extensions

```bash
# Process .tpl, .md, and .yaml files as templates
templr walk --src templates/ --dst output/ --ext md --ext yaml
```

### With Guard Protection

```bash
# Only overwrite files containing guard marker
templr walk --src templates/ --dst output/ --guard "#generated by templr"

# Disable guard injection
templr walk --src templates/ --dst output/ --inject-guard=false
```

---

## Linting and Validation

### Basic Linting

```bash
# Lint single file
templr lint -i template.tpl -d values.yaml

# Lint directory
templr lint --dir templates/ -d values.yaml

# Lint entire tree
templr lint --src templates/ -d values.yaml
```

### CI/CD Linting

```bash
# Fail on warnings
templr lint --src templates/ -d values.yaml --fail-on-warn

# Skip undefined variable check (syntax only)
templr lint --src templates/ --no-undefined-check

# JSON output for programmatic use
templr lint --src templates/ -d values.yaml --format json

# GitHub Actions annotations
templr lint --src templates/ -d values.yaml --format github-actions
```

### With Configuration

**.templr.yaml:**
```yaml
lint:
  fail_on_warn: true
  fail_on_undefined: true
  required_vars:
    - name
    - version
    - environment
  disallow_functions:
    - env
    - exec
  exclude:
    - "_*.tpl"
    - "**/test/**"
```

**Lint:**
```bash
# Uses .templr.yaml automatically
templr lint --src templates/ -d values.yaml
```

---

## CI/CD Integration

### GitHub Actions

**.github/workflows/lint.yml:**
```yaml
name: Lint Templates
on: [push, pull_request]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Install templr
        run: |
          curl -fsSL https://raw.githubusercontent.com/kanopi/templr/main/get-templr.sh | bash
          sudo mv templr /usr/local/bin/

      - name: Lint templates
        run: |
          templr lint \
            --src templates/ \
            -d values.yaml \
            --format github-actions \
            --fail-on-warn
```

**.github/workflows/deploy.yml:**
```yaml
name: Deploy
on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Install templr
        run: |
          curl -fsSL https://raw.githubusercontent.com/kanopi/templr/main/get-templr.sh | bash
          sudo mv templr /usr/local/bin/

      - name: Validate templates
        run: templr lint --src templates/ -d values.prod.yaml --fail-on-warn

      - name: Render templates
        run: templr walk --src templates/ --dst manifests/ -data values.prod.yaml

      - name: Deploy to Kubernetes
        run: kubectl apply -f manifests/
```

### GitLab CI

**.gitlab-ci.yml:**
```yaml
stages:
  - lint
  - deploy

lint:
  stage: lint
  image: alpine:latest
  before_script:
    - apk add --no-cache curl bash
    - curl -fsSL https://raw.githubusercontent.com/kanopi/templr/main/get-templr.sh | bash
    - mv templr /usr/local/bin/
  script:
    - templr lint --src templates/ -d values.yaml --fail-on-warn
  only:
    - merge_requests
    - main

deploy:production:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache curl bash kubectl
    - curl -fsSL https://raw.githubusercontent.com/kanopi/templr/main/get-templr.sh | bash
    - mv templr /usr/local/bin/
  script:
    - templr walk --src templates/ --dst manifests/ -data values.prod.yaml
    - kubectl apply -f manifests/
  only:
    - main
  environment:
    name: production
```

### CircleCI

**.circleci/config.yml:**
```yaml
version: 2.1

jobs:
  lint:
    docker:
      - image: cimg/base:stable
    steps:
      - checkout
      - run:
          name: Install templr
          command: |
            curl -fsSL https://raw.githubusercontent.com/kanopi/templr/main/get-templr.sh | bash
            sudo mv templr /usr/local/bin/
      - run:
          name: Lint templates
          command: templr lint --src templates/ -d values.yaml --fail-on-warn

workflows:
  version: 2
  lint-and-deploy:
    jobs:
      - lint
```

---

## Team Workflows

### Developer Setup

**Project .templr.yaml** (committed):
```yaml
lint:
  required_vars:
    - appName
    - environment
  disallow_functions:
    - env
  fail_on_undefined: true

files:
  extensions: [yaml, tpl]
  default_values_file: ./values.yaml
```

**Personal ~/.config/templr/config.yaml** (not committed):
```yaml
output:
  color: always
  verbose: true

render:
  dry_run: true  # Always preview first
```

### Multi-Environment Deployment

**Structure:**
```
project/
├── .templr.yaml
├── .templr.dev.yaml
├── .templr.prod.yaml
├── values.yaml
├── values.dev.yaml
├── values.prod.yaml
└── templates/
```

**Deploy to development:**
```bash
templr lint --config .templr.dev.yaml --src templates/
templr walk --config .templr.dev.yaml --src templates/ --dst output/
```

**Deploy to production:**
```bash
# Strict validation
templr lint --config .templr.prod.yaml --src templates/

# Render with production values
templr walk --config .templr.prod.yaml --src templates/ --dst output/
```

---

## Advanced Patterns

### Kubernetes Deployment Pipeline

**values.prod.yaml:**
```yaml
app:
  name: myapp
  version: "1.0.0"
  replicas: 3
  image: myregistry/myapp:1.0.0

database:
  host: prod-db.example.com
  port: 5432
  name: myapp_prod

ingress:
  host: myapp.example.com
  tls: true
```

**.templr.prod.yaml:**
```yaml
files:
  extensions: [yaml, tpl]
  default_values_file: ./values.prod.yaml

lint:
  fail_on_warn: true
  fail_on_undefined: true
  required_vars:
    - app.name
    - app.version
    - app.replicas
    - database.host

render:
  inject_guard: true
  guard_string: "# Generated by templr - DO NOT EDIT"
```

**Deploy script:**
```bash
#!/bin/bash
set -e

ENV=${1:-dev}
CONFIG=".templr.${ENV}.yaml"

echo "Deploying to $ENV environment..."

# Validate
echo "Validating templates..."
templr lint --config "$CONFIG" --src templates/

# Render
echo "Rendering manifests..."
templr walk --config "$CONFIG" --src templates/ --dst manifests/

# Apply
echo "Applying to Kubernetes..."
kubectl apply -f manifests/

echo "Deployment complete!"
```

### Documentation Generation

**docs/templates/api.md.tpl:**
```markdown
# {{ .api.name }} API Documentation

Version: {{ .api.version }}

## Endpoints

{{- range .api.endpoints }}

### {{ .method }} {{ .path }}

{{ .description }}

**Parameters:**
{{- range .parameters }}
- `{{ .name }}` ({{ .type }}): {{ .description }}
{{- end }}

**Response:**
```json
{{ .response | toJson }}
\```
{{- end }}
```

**Generate:**
```bash
templr walk --src docs/templates/ --dst docs/ --ext md -data api-spec.yaml
```

### Configuration Management

**templates/nginx.conf.tpl:**
```nginx
server {
    listen {{ .server.port }};
    server_name {{ .server.name }};

    {{- if .ssl.enabled }}
    ssl_certificate {{ .ssl.cert }};
    ssl_certificate_key {{ .ssl.key }};
    {{- end }}

    location / {
        proxy_pass http://{{ .upstream.host }}:{{ .upstream.port }};
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

**Generate configs:**
```bash
# Development
templr render -in templates/nginx.conf.tpl \
  -data configs/dev.yaml \
  -out /etc/nginx/conf.d/app.conf

# Production
templr render -in templates/nginx.conf.tpl \
  -data configs/prod.yaml \
  -out /etc/nginx/conf.d/app.conf
```

---

## Next Steps

- [Templating Guide](templating-guide.md) - Learn template syntax
- [Configuration Guide](configuration.md) - Set up `.templr.yaml`
- [CLI Reference](cli-reference.md) - All commands and flags
- [Back to Documentation Hub](README.md)
