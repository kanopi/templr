version: 2.1

DOCKER_IMAGE: &DOCKER_IMAGE "kanopi/templr"

DOCKER_CREDS: &DOCKER_CREDS
  docker_username: DOCKERHUB_USER
  docker_password: DOCKERHUB_TOKEN

ONLY_TAGS: &ONLY_TAGS
  context: kanopi-code
  filters:
    tags:
      only: /.*/
    branches:
      ignore: /.*/

ONLY_BRANCHES: &ONLY_BRANCHES
  context: kanopi-code
  filters:
    tags:
      ignore: /.*/
    branches:
      only: /.*/

orbs:
  ci-tools: kanopi/ci-tools@2
  docker: circleci/docker@3

executors:
  go-executor:
    docker:
      - image: cimg/go:1.23
        auth:
          username: $DOCKERHUB_USER
          password: $DOCKERHUB_TOKEN
    working_directory: ~/project

jobs:
  lint:
    executor: go-executor
    steps:
      - checkout
      - run:
          name: Install golangci-lint
          command: |
            curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh \
              | sh -s -- -b $(go env GOPATH)/bin v2.6.0
      - run:
          name: Run golangci-lint
          command: |
            golangci-lint run --timeout 5m
  unit:
    executor: go-executor
    steps:
      - checkout
      - run:
          name: Run unit tests
          command: |
            go test ./tests/...
  test:
    executor: go-executor
    steps:
      - checkout
      - restore_cache:
          keys:
            - v1-go-mod-{{ checksum "go.sum" }}
            - v1-go-mod-
      - run:
          name: Install dependencies
          command: |
            go mod tidy
      - save_cache:
          key: v1-go-mod-{{ checksum "go.sum" }}
          paths:
            - ~/go/pkg/mod
      - run:
          name: Build project
          command: go build -o .bin/templr .
      - run:
          name: Run tests
          command: |
            tests/run_examples.sh
      - store_artifacts:
          path: .out
          destination: test-results
      - store_test_results:
          path: .out

  build:
    executor: go-executor
    steps:
      - checkout
      - restore_cache:
          keys:
            - v1-go-mod-{{ checksum "go.sum" }}
            - v1-go-mod-
      - run:
          name: Install GoReleaser / Syft / Chocolatey
          command: |
            set +e  # Don't fail on errors, we'll handle them gracefully

            # Install GoReleaser
            curl -sfL https://goreleaser.com/static/run | bash -s -- check
            curl -sL https://git.io/goreleaser | bash -s -- --version

            # Install Syft
            curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sudo sh -s -- -b /usr/local/bin

            # Install Mono runtime (required for choco.exe)
            echo "Installing Mono runtime..."
            sudo apt-get update -qq
            sudo DEBIAN_FRONTEND=noninteractive apt-get install -y mono-runtime mono-devel wget unzip 2>&1 | grep -v "invoke-rc.d\|Use of uninitialized" || true

            # Verify mono is available
            if command -v mono &> /dev/null; then
              echo "✓ Mono installed: $(mono --version | head -1)"
            else
              echo "✗ Mono installation failed"
              exit 1
            fi

            set -e  # Re-enable exit on error

            # Install Chocolatey CLI (portable version)
            if ! command -v choco &> /dev/null; then
              echo "Installing Chocolatey CLI..."

              # Download and extract Chocolatey portable
              CHOCO_VERSION="2.5.1"
              sudo mkdir -p /opt/chocolatey
              sudo wget -q "https://github.com/chocolatey/choco/releases/download/${CHOCO_VERSION}/chocolatey.v${CHOCO_VERSION}.zip" -O /tmp/choco.zip
              sudo unzip -q /tmp/choco.zip -d /opt/chocolatey

              # Create wrapper script that runs choco.exe with mono
              sudo tee /usr/local/bin/choco > /dev/null \<\<'EOF'
              #!/bin/bash
              exec mono /opt/chocolatey/tools/choco.exe "$@"
              EOF
              sudo chmod +x /usr/local/bin/choco

              # Verify
              if choco --version 2>/dev/null; then
                echo "✓ Chocolatey CLI installed successfully"
              else
                echo "⚠ Warning: Chocolatey installation may have failed"
              fi

              # Cleanup
              rm -f /tmp/choco.zip
            fi
      - setup_remote_docker:
          version: 20.10.24
      - run:
          name: Docker Login
          command: |
            echo "$DOCKERHUB_TOKEN" | docker login -u "$DOCKERHUB_USER" --password-stdin
      - run:
          name: Setup Docker Buildx
          command: |
            docker buildx create --name multiarch --driver docker-container --use --bootstrap || true
            docker buildx inspect multiarch
            docker run --privileged --rm tonistiigi/binfmt --install arm64,amd64
      - when:
          condition:
            equal: ["", << pipeline.git.tag >>]
          steps:
            - run:
                name: Build Snapshot (Branch Build)
                command: |
                  curl -sL https://git.io/goreleaser | bash -s -- build --snapshot --clean
            - store_artifacts:
                path: dist
                destination: templr-artifacts
      - unless:
          condition:
            equal: ["", << pipeline.git.tag >>]
          steps:
            - run:
                name: GoReleaser Release
                command: |
                  # Create GitHub release and build all artifacts
                  curl -sL https://git.io/goreleaser | bash -s -- release --clean
            - run:
                name: Build Web Playground
                command: |
                  bash ./deploy.sh || echo "Web playground deploy skipped"
            - store_artifacts:
                path: dist
                destination: templr-artifacts

workflows:
  version: 2
  test-and-build:
    jobs:
      - lint:
          <<: *ONLY_BRANCHES
      - unit:
          <<: *ONLY_BRANCHES
      - test:
          <<: *ONLY_BRANCHES
      - build:
          <<: *ONLY_BRANCHES
          name: "Build Branch"
          requires:
            - lint
            - unit
            - test
      - build:
          <<: *ONLY_TAGS
          name: "Build Release"
