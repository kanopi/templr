version: 2.1

orbs:
  ci-tools: kanopi/ci-tools@2
  docker: circleci/docker@3

executors:
  go-executor:
    docker:
      - image: cimg/go:1.23
        auth:
          username: $DOCKERHUB_USER
          password: $DOCKERHUB_PASS
    working_directory: ~/project

jobs:
  test:
    executor: go-executor
    steps:
      - checkout
      - restore_cache:
          keys:
            - v1-go-mod-{{ checksum "go.sum" }}
            - v1-go-mod-
      - run:
          name: Install dependencies
          command: |
            go mod tidy
      - save_cache:
          key: v1-go-mod-{{ checksum "go.sum" }}
          paths:
            - ~/go/pkg/mod
      - run:
          name: Build project
          command: go build -o .bin/templr .
      - run:
          name: Run tests
          command: |
            tests/run_examples.sh
      - store_artifacts:
          path: .out
          destination: test-results
      - store_test_results:
          path: .out

  build:
    executor: go-executor
    steps:
      - checkout
      - ci-tools/install-github-cli
      - restore_cache:
          keys:
            - v1-go-mod-{{ checksum "go.sum" }}
            - v1-go-mod-
      - run:
          name: Build templr (multi-platform) with version + PIE, archive, checksums
          command: |
            set -e
            mkdir -p .bin dist

            if [[ -n "${CIRCLE_TAG:-}" ]]; then
              LDFLAGS="-X main.Version=${CIRCLE_TAG}"
              VERSION="${CIRCLE_TAG}"
            else
              LDFLAGS="-X main.GitBranch=${CIRCLE_BRANCH}"
              VERSION="${CIRCLE_BRANCH}-dev"
            fi

            export GOFLAGS="-trimpath -buildmode=pie"

            # Linux (dynamic glibc)
            GOOS=linux   GOARCH=amd64 go build -ldflags "$LDFLAGS" -o .bin/templr-linux-amd64 .
            GOOS=linux   GOARCH=arm64 go build -ldflags "$LDFLAGS" -o .bin/templr-linux-arm64 .

            # macOS
            GOOS=darwin  GOARCH=amd64 go build -ldflags "$LDFLAGS" -o .bin/templr-darwin-amd64 .
            GOOS=darwin  GOARCH=arm64 go build -ldflags "$LDFLAGS" -o .bin/templr-darwin-arm64 .

            # Windows
            GOOS=windows GOARCH=amd64 go build -ldflags "$LDFLAGS" -o .bin/templr-windows-amd64.exe .

            # Package as zips with docs
            for f in .bin/*; do
              base=$(basename "$f")
              zip -j "dist/${base}.zip" "$f" LICENSE README.md || zip -j "dist/${base}.zip" "$f"
            done

            # Checksums
            (cd dist && sha256sum * > SHA256SUMS)

      # (Optional) SBOM (requires anchore/syft pre-installed or add a setup step)
      - run:
          name: Generate SBOM (syft)
          command: |
            curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b .bin
            for z in dist/*.zip; do
              .bin/syft packages file:"$z" -o spdx-json > "${z%.zip}.spdx.json" || true
            done

      # (Optional) Cosign signatures (requires keys/secrets)
      - run:
          name: Sign checksums with cosign
          command: |
            # cosign sign-blob --key $COSIGN_KEY dist/SHA256SUMS > dist/SHA256SUMS.sig
            echo "Add cosign signing here if keys are available"

      - store_artifacts:
          path: dist
          destination: templr-artifacts

      - persist_to_workspace:
          root: .
          paths:
            - .bin

      - when:
          condition:
            not:
              equal: ["", << pipeline.git.tag >>]
          steps:
            - run:
                name: Post Artifact
                command: |
                  for f in .bin/templr*; do
                    gh -R "github.com/${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME}" release upload ${CIRCLE_TAG} "${f}" --clobber
                  done
  
  build_docker:
    executor: go-executor
    steps:
      - checkout
      - setup_remote_docker
      - docker/check:
          arch: amd64
          docker_username: DOCKERHUB_USER
          docker_password: DOCKERHUB_PASS
      - docker/check:
          arch: arm64
          docker_username: DOCKERHUB_USER
          docker_password: DOCKERHUB_PASS
      - run:
          name: Build Multi Builder
          command: make builder
      - when:
          condition:
            equal: ["", << pipeline.git.tag >>]
          steps:
            - docker/build:
                attach_at: .
                image: kanopi/templr
                tag: "build-$(echo \"${CIRCLE_BRANCH}\" | tr '[:upper:]' '[:lower:]' | tr '/' '-' | tr -cd 'a-z0-9_.-'),build-$(echo \"${CIRCLE_BRANCH}\" | tr '[:upper:]' '[:lower:]' | tr '/' '-' | tr -cd 'a-z0-9_.-')-${CIRCLE_SHA1:0:7}"
                extra_build_args: "--platform linux/amd64,linux/arm64 --push"
      - unless:
          condition:
            equal: ["", << pipeline.git.tag >>]
          steps:
            - docker/build:
                attach_at: .
                image: kanopi/templr
                tag: "<< pipeline.git.tag >>"
                extra_build_args: "--platform linux/amd64,linux/arm64 --push"
            - docker/update_description:
                docker_username: DOCKERHUB_USER
                docker_password: DOCKERHUB_PASS
                image: kanopoi/templr

workflows:
  version: 2
  test-and-build:
    jobs:
      - test:
          context: kanopi-code
          filters:
            tags:
              only: /.*/
            branches:
              only: /.*/
      - build:
          context: kanopi-code
          requires:
            - test
          filters:
            tags:
              only: /.*/
            branches:
              only: /.*/
      - build_docker:
          context: kanopi-code
          requires:
            - build
          filters:
            tags:
              only: /.*/
            branches:
              only: /.*/
