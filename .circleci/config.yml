

version: 2.1

executors:
  go-executor:
    docker:
      - image: cimg/go:1.23
    working_directory: ~/project

jobs:
  test:
    executor: go-executor
    steps:
      - checkout
      - restore_cache:
          keys:
            - v1-go-mod-{{ checksum "go.sum" }}
            - v1-go-mod-
      - run:
          name: Install dependencies
          command: |
            go mod tidy
      - save_cache:
          key: v1-go-mod-{{ checksum "go.sum" }}
          paths:
            - ~/go/pkg/mod
      - run:
          name: Build project
          command: go build -o .bin/templr .
      - run:
          name: Run tests
          command: |
            tests/run_examples.sh
      - store_artifacts:
          path: .out
          destination: test-results
      - store_test_results:
          path: .out

  build:
    executor: go-executor
    steps:
      - checkout
      - restore_cache:
          keys:
            - v1-go-mod-{{ checksum "go.sum" }}
            - v1-go-mod-
      - run:
          name: Build templr (multi-platform) with version + trimpath
          command: |
            set -e
            mkdir -p .bin dist
            if [[ -n "${CIRCLE_TAG:-}" ]]; then
              LDFLAGS="-X main.Version=${CIRCLE_TAG}"
              VERSION="${CIRCLE_TAG}"
            else
              LDFLAGS="-X main.GitBranch=${CIRCLE_BRANCH}"
              VERSION="${CIRCLE_BRANCH}-dev"
            fi
            export GOFLAGS="-trimpath"

            # Linux (prefer dynamic glibc to avoid heuristic flags)
            GOOS=linux   GOARCH=amd64 go build -ldflags "$LDFLAGS" -o .bin/templr-linux-amd64 .
            GOOS=linux   GOARCH=arm64 go build -ldflags "$LDFLAGS" -o .bin/templr-linux-arm64 .

            # macOS
            GOOS=darwin  GOARCH=amd64 go build -ldflags "$LDFLAGS" -o .bin/templr-darwin-amd64 .
            GOOS=darwin  GOARCH=arm64 go build -ldflags "$LDFLAGS" -o .bin/templr-darwin-arm64 .

            # Windows
            GOOS=windows GOARCH=amd64 go build -ldflags "$LDFLAGS" -o .bin/templr-windows-amd64.exe .

            # Package as zips (friendlier to scanners)
            for f in .bin/*; do
              base=$(basename "$f")
              zip -j "dist/${base}.zip" "$f" LICENSE README.md || zip -j "dist/${base}.zip" "$f"
            done

            # Checksums
            (cd dist && sha256sum * > SHA256SUMS)

      # (Optional) SBOM (requires anchore/syft pre-installed or add a setup step)
      # - run:
      #     name: Generate SBOM (syft)
      #     command: |
      #       curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b .bin
      #       for z in dist/*.zip; do
      #         .bin/syft packages file:"$z" -o spdx-json > "${z%.zip}.spdx.json" || true
      #       done

      # (Optional) Cosign signatures (requires keys/secrets)
      # - run:
      #     name: Sign checksums with cosign
      #     command: |
      #       # cosign sign-blob --key $COSIGN_KEY dist/SHA256SUMS > dist/SHA256SUMS.sig
      #       echo "Add cosign signing here if keys are available"

      - store_artifacts:
          path: dist
          destination: templr-artifacts

workflows:
  version: 2
  test-and-build:
    jobs:
      - test
      - build:
          requires:
            - test