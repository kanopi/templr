version: 2.1

DOCKER_IMAGE: &DOCKER_IMAGE "kanopi/templr"

DOCKER_CREDS: &DOCKER_CREDS
  docker_username: DOCKERHUB_USER
  docker_password: DOCKERHUB_TOKEN

ONLY_TAGS: &ONLY_TAGS
  context: kanopi-code
  filters:
    tags:
      only: /.*/
    branches:
      ignore: /.*/

ONLY_BRANCHES: &ONLY_BRANCHES
  context: kanopi-code
  filters:
    tags:
      ignore: /.*/
    branches:
      only: /.*/

orbs:
  ci-tools: kanopi/ci-tools@2
  docker: circleci/docker@3

executors:
  go-executor:
    docker:
      - image: cimg/go:1.23
        auth:
          username: $DOCKERHUB_USER
          password: $DOCKERHUB_TOKEN
    working_directory: ~/project

jobs:
  lint:
    executor: go-executor
    steps:
      - checkout
      - run:
          name: Install golangci-lint
          command: |
            curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh \
              | sh -s -- -b $(go env GOPATH)/bin v2.6.0
      - run:
          name: Run golangci-lint
          command: |
            golangci-lint run --timeout 5m
  unit:
    executor: go-executor
    steps:
      - checkout
      - run:
          name: Run unit tests
          command: |
            go test ./tests/...
  test:
    executor: go-executor
    steps:
      - checkout
      - restore_cache:
          keys:
            - v1-go-mod-{{ checksum "go.sum" }}
            - v1-go-mod-
      - run:
          name: Install dependencies
          command: |
            go mod tidy
      - save_cache:
          key: v1-go-mod-{{ checksum "go.sum" }}
          paths:
            - ~/go/pkg/mod
      - run:
          name: Build project
          command: go build -o .bin/templr .
      - run:
          name: Run tests
          command: |
            tests/run_examples.sh
      - store_artifacts:
          path: .out
          destination: test-results
      - store_test_results:
          path: .out

  test_windows:
    machine:
      image: windows-server-2019-vs2019:stable
    resource_class: windows.medium
    steps:
      - checkout
      - run:
          name: Install Go
          command: |
            choco install -y golang
      - run:
          name: Install dependencies
          command: |
            go mod tidy
      - run:
          name: Build project
          command: |
            go build -o .bin/templr.exe .
      - run:
          name: Run Go tests
          command: |
            go test ./...

  build:
    executor: go-executor
    steps:
      - checkout
      - restore_cache:
          keys:
            - v1-go-mod-{{ checksum "go.sum" }}
            - v1-go-mod-
      - run:
          name: Install GoReleaser / Syft
          command: |
            # Install GoReleaser
            curl -sfL https://goreleaser.com/static/run | bash -s -- check
            curl -sL https://git.io/goreleaser | bash -s -- --version

            # Install Syft
            curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sudo sh -s -- -b /usr/local/bin
      - setup_remote_docker:
          version: 20.10.24
      - run:
          name: Docker Login
          command: |
            echo "$DOCKERHUB_TOKEN" | docker login -u "$DOCKERHUB_USER" --password-stdin
      - run:
          name: Setup Docker Buildx
          command: |
            docker buildx create --name multiarch --driver docker-container --use --bootstrap || true
            docker buildx inspect multiarch
            docker run --privileged --rm tonistiigi/binfmt --install arm64,amd64
      - when:
          condition:
            equal: ["", << pipeline.git.tag >>]
          steps:
            - run:
                name: Build Snapshot (Branch Build)
                command: |
                  curl -sL https://git.io/goreleaser | bash -s -- build --snapshot --clean
            - store_artifacts:
                path: dist
                destination: templr-artifacts
      - unless:
          condition:
            equal: ["", << pipeline.git.tag >>]
          steps:
            - run:
                name: GoReleaser Release
                command: |
                  # Create GitHub release and build all artifacts
                  curl -sL https://git.io/goreleaser | bash -s -- release --clean --skip=chocolatey
            - run:
                name: Build Web Playground
                command: |
                  bash ./deploy.sh || echo "Web playground deploy skipped"
            - store_artifacts:
                path: dist
                destination: templr-artifacts
            - persist_to_workspace:
                root: .
                paths:
                  - dist

  choco_publish:
    machine:
      image: windows-server-2019-vs2019:stable
    resource_class: windows.medium
    steps:
      - checkout
      - attach_workspace:
          at: .
      - run:
          name: Install GoReleaser
          command: |
            choco install -y goreleaser
      - run:
          name: Publish Chocolatey Package
          command: |
            # Use existing dist artifacts from Linux build
            # Only run chocolatey publisher, skip all builds
            goreleaser release --skip=build,docker,nfpm,sbom,homebrew,announce,validate

workflows:
  version: 2
  test-and-build:
    jobs:
      - lint:
          <<: *ONLY_BRANCHES
      - unit:
          <<: *ONLY_BRANCHES
      - test:
          <<: *ONLY_BRANCHES
      - test_windows:
          <<: *ONLY_BRANCHES
      - build:
          <<: *ONLY_BRANCHES
          name: "Build Branch"
          requires:
            - lint
            - unit
            - test
            - test_windows
      - build:
          <<: *ONLY_TAGS
          name: "Build Release"
      - choco_publish:
          <<: *ONLY_TAGS
          name: "Choco Release"
          requires:
            - "Build Release"